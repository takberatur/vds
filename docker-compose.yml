# version: "3.8"

services:
  # Backend Service (Go + Fiber)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: video_downloader_api
    restart: always
    ports:
      - "5001:5001"
    environment:
      - APP_PORT=5001
      - APP_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_URL=${DB_URL}
      - CLIENT_URL=${CLIENT_URL}
      - REDIS_ADDR=${REDIS_ADDR}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRY_HOUR=${JWT_EXPIRY_HOUR}
      - MINIO_ENDPOINT=${MINIO_ENDPOINT}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_BUCKET=${MINIO_BUCKET}
      - MINIO_USE_SSL=${MINIO_USE_SSL}
      - CENTRIFUGO_WS_URL=${CENTRIFUGO_WS_URL}
      - CENTRIFUGO_API_KEY=${CENTRIFUGO_API_KEY}
      - BCRYPT_COST=${BCRYPT_COST}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
    networks:
      - video_download_network
      - shared-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  #vFrontend Service 01 (SvelteKit)
  # frontend_01:
  #   build:
  #     context: ./frontend
  #     dockerfile: Dockerfile
  #   container_name: video_downloader_web_01
  #   restart: always
  #   ports:
  #     - "3002:3002"
  #   environment:
  #     - NODE_ENV=production
  #     - PUBLIC_API_URL=http://backend:5001
  #     - PUBLIC_GOOGLE_CLIENT_ID=${PUBLIC_GOOGLE_CLIENT_ID}
  #     - PUBLIC_GOOGLE_CLIENT_SECRET=${PUBLIC_GOOGLE_CLIENT_SECRET}
  #     - PORT=3002
  #     - HOST=0.0.0.0
  #     - ORIGIN=${ORIGIN}
  #     - PROTOCOL_HEADER=x-forwarded-proto
  #     - HOST_HEADER=x-forwarded-host
  #     - ADDRESS_HEADER=True-Client-IP
  #     - BODY_SIZE_LIMIT=100M
  #     - SIGTERM=30
  #     - BUN_JSC_useJIT=1
  #     - BUN_JSC_jitThreshold=50 # more agresif
  #     - BUN_JSC_useDFGJIT=1
  #     - BUN_JSC_useFTLJIT=1
  #   depends_on:
  #     - backend
  #   networks:
  #     - shared-network
  #     - video_download_network

  worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: video_downloader_worker
    restart: always
    environment:
      - APP_PORT=5001
      - APP_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_URL=${DB_URL}
      - REDIS_ADDR=${REDIS_ADDR}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    networks:
      - video_download_network
      - shared-network
    command: ["./worker"]
    healthcheck:
      test: ["CMD", "pgrep", "worker"]
      interval: 30s
      timeout: 10s
      retries: 3

  setup:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: video_downloader_setup
    restart: "no"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_URL=${DB_URL}
    networks:
      - infrastructure-network
    command: >
      /bin/sh -c "
      echo 'Waiting for PostgreSQL to be ready...'
      until pg_isready -h infrastructure-postgres -p 5432 -U ${DB_USER}; do
        echo 'Waiting for PostgreSQL...'
        sleep 2
      done
      echo 'Running migrations...'
      migrate -path internal/repository/migrations -database $${DATABASE_URL} up
      echo 'Running seeders...'
      ./seed
      echo 'Setup completed!'
      "
    profiles: ["setup"]

networks:
  video_download_network:
    driver: bridge

  shared-network:
    external: true
    name: shared-network
