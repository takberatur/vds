name: Deploy to Ubuntu Server

on:
  push:
    branches: [ main, master ]
    paths-ignore:
    - '**/android/**'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        sparse-checkout: |
          !android
        sparse-checkout-cone-mode: false

    - name: Deploy to Server via SSH
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /var/www/video-downloader

          BACKUP_DIR="/tmp/backup_$(date +%Y%m%d_%H%M%S)"
          mkdir -p $BACKUP_DIR

          EXCLUDE_LIST=(
            "android/"
          )

          # Create exclude string for tar
          EXCLUDE_TAR=""
          for item in "${EXCLUDE_LIST[@]}"; do
            EXCLUDE_TAR+=" --exclude='$item'"
          done

          # Backup current excluded files
          echo "Backing up excluded files..."
          tar czf $BACKUP_DIR/backup.tar.gz $EXCLUDE_TAR .

          # Hard reset from git
          echo "Fetching latest code..."
          git fetch origin

          # Clean except excluded files
          echo "Cleaning workspace..."
          git clean -fd -e android

          # Reset to origin
          echo "Resetting to origin/main..."
          git reset --hard origin/main

          # Restore excluded files from backup
          echo "Restoring excluded files..."
          tar -xzf $BACKUP_DIR/backup.tar.gz -C .

          # Set permissions
          chmod 600 .env 2>/dev/null || true
          chmod -R 755 uploads 2>/dev/null || true

          echo "Deployment completed!"
